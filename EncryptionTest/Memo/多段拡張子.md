```md
# SaveFileDialog 多段拡張子（.csv.enc）問題まとめ  
対象：WinForms（.NET Framework 4.7） / WPF

---

# 概要

SaveFileDialog において多段拡張子（例：`.csv.enc`）を使用した場合、  
以下のような現象が発生することがあります。

```

Filename.csv.enc  →  Filename.csv.enc.csv.enc

```

これはバグではなく、**仕様上の動作**です。

---

# なぜ二重になるのか？

SaveFileDialog は内部的に：

- 「最後のドット以降」を拡張子と認識する
- Filter に一致しないと判断すると拡張子を自動付与する

例：

```

Filename.csv.enc

```

内部認識：

```

拡張子 = .enc

```

Filter が：

```

*.csv.enc

````

の場合、

> 「.csv.enc ではない」と判断される  
→ `.csv.enc` を追加  
→ `Filename.csv.enc.csv.enc`

---

# WinForms（.NET Framework 4.7）

使用クラス：

```csharp
System.Windows.Forms.SaveFileDialog
````

## 特徴

* AddExtension = true（デフォルト）
* DefaultExt が有効
* Win32 API（GetSaveFileName）ベース
* 多段拡張子を1つとして扱わない

---

## 推奨対策（WinForms）

### 1. AddExtension を無効にする

```csharp
sfd.AddExtension = false;
```

### 2. 保存前に手動で拡張子保証

```csharp
string path = sfd.FileName;

if (!path.EndsWith(".csv.enc", StringComparison.OrdinalIgnoreCase))
{
    path += ".csv.enc";
}
```

---

## 注意

`Path.ChangeExtension()` は多段拡張子で壊れる可能性あり。

```csharp
Path.ChangeExtension("file.csv.enc", "csv.enc")
```

→ 期待通りにならない場合がある

---

# WPF

使用クラス：

```csharp
Microsoft.Win32.SaveFileDialog
```

## 特徴

* WinFormsとほぼ同様の挙動
* 多段拡張子問題は同様に発生
* 最後のドット以降のみ拡張子と認識

---

## 推奨対策（WPF）

```csharp
var dlg = new Microsoft.Win32.SaveFileDialog();
dlg.FileName = "Filename.csv.enc";
dlg.Filter = "Encrypted CSV (*.csv.enc)|*.csv.enc";
dlg.AddExtension = false;

if (dlg.ShowDialog() == true)
{
    string path = dlg.FileName;

    if (!path.EndsWith(".csv.enc", StringComparison.OrdinalIgnoreCase))
    {
        path += ".csv.enc";
    }

    // 保存処理
}
```

---

# 実務向け安全パターン（共通）

## 拡張子保証メソッドを作成

```csharp
public static string EnsureExtension(string path, string requiredExtension)
{
    if (!path.EndsWith(requiredExtension, StringComparison.OrdinalIgnoreCase))
    {
        return path + requiredExtension;
    }

    return path;
}
```

使用例：

```csharp
string filePath = EnsureExtension(dlg.FileName, ".csv.enc");
```

---

# 設計的ベストプラクティス（暗号化アプリ向け）

暗号化ファイル：

* .csv.enc
* .json.enc
* .xlsx.enc

のように増える可能性がある場合、

拡張子ポリシーをクラス化するのが理想。

例：

```csharp
public class ExportOptions
{
    public string RequiredExtension { get; set; } = ".csv.enc";
}
```

保存直前で必ず保証する。

---

# まとめ

| 項目                   | WinForms           | WPF                |
| -------------------- | ------------------ | ------------------ |
| 多段拡張子問題              | 発生する               | 発生する               |
| 原因                   | 最後の拡張子のみ認識         | 同様                 |
| 推奨対策                 | AddExtension=false | AddExtension=false |
| 最終保証                 | 手動で行う              | 手動で行う              |
| Path.ChangeExtension | 非推奨                | 非推奨                |

---

# 結論

* これは仕様上の動作
* フレームワーク差はほぼない
* 暗号化アプリでは必ず拡張子を手動保証する設計にする

```
```
